<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICL Farm Nutrient Flow Calculator - Complete Manure Chain</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: 600;
        }
        
        .tab:hover {
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 18px;
            color: #2c3e50;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #3498db;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .input-section {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .livestock-entry, .feed-entry, .crop-entry {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .export-entry {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
            position: relative;
        }

        .export-entry .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .export-entry .remove-btn:hover {
            background: #c0392b;
        }
        
        .manure-treatment-box {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .manure-destination-box {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .manure-summary {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .manure-summary h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .flow-diagram {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #3498db;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .flow-arrow {
            margin: 0 15px;
            color: #3498db;
            font-size: 20px;
            font-weight: bold;
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            padding: 8px 16px;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .btn-remove {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .help-text {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 4px;
            font-style: italic;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 13px;
        }
        
        .results-table th {
            background: #2c3e50;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .results-table .category-header {
            background: #3498db;
            color: white;
            font-weight: 600;
        }
        
        .results-table .total-row {
            background: #34495e;
            color: white;
            font-weight: 600;
        }
        
        .indicator-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .indicator-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .indicator-card h3 {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .indicator-card .value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .indicator-card .unit {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .entry-header h4 {
            color: #2c3e50;
            font-size: 15px;
        }
        
        .balance-check {
            background: #fff9c4;
            border: 2px solid #fbc02d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .balance-check h4 {
            color: #f57f17;
            margin-bottom: 10px;
        }
        
        .percentage-input {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 5px;
        }
        
        .percentage-input input {
            width: 100%;
        }
        
        .percentage-input span {
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåæ ICL Farm Nutrient Flow Calculator</h1>
            <p>Complete Manure Management Chain - From Production to Application</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('farm-info')">Farm Info</button>
                <button class="tab" onclick="switchTab('livestock')">Livestock</button>
                <button class="tab" onclick="switchTab('feed')">Feed</button>
                <button class="tab" onclick="switchTab('crops')">Crops</button>
                <button class="tab" onclick="switchTab('manure-production')">Manure Production</button>
                <button class="tab" onclick="switchTab('manure-treatment')">Manure Treatment</button>
                <button class="tab" onclick="switchTab('manure-destination')">Manure Destination</button>
                <button class="tab" onclick="switchTab('other-inputs')">Other Inputs</button>
                <button class="tab" onclick="switchTab('results')">Results</button>
            </div>
            
            <!-- Farm Information Tab -->
            <div id="farm-info" class="tab-content active">
                <div class="alert alert-info">
                    <strong>Complete Nutrient Flow Tracking!</strong> This enhanced calculator tracks the complete manure management chain:
                    Animal ‚Üí Manure Production ‚Üí Treatment (Digestion/Composting/Storage) ‚Üí Destination (Land Application/Sale/Loss)
                </div>
                
                <div class="input-section">
                    <h2 class="section-title">Basic Farm Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Farm Name *</label>
                            <input type="text" id="farmName" placeholder="Enter farm name" required>
                        </div>
                        <div class="form-group">
                            <label>Location *</label>
                            <input type="text" id="farmLocation" placeholder="City, Province">
                        </div>
                        <div class="form-group">
                            <label>Total Farm Area (ha) *</label>
                            <input type="number" id="farmArea" placeholder="Area in hectares" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Assessment Year *</label>
                            <input type="number" id="assessmentYear" placeholder="e.g., 2024" min="2000" max="2030">
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn" onclick="switchTab('livestock')">Next: Livestock Data ‚Üí</button>
                </div>
            </div>
            
            <!-- Livestock Tab -->
            <div id="livestock" class="tab-content">
                <h2 class="section-title">Livestock Inventory</h2>
                <div id="livestockContainer"></div>
                <button class="btn btn-add" onclick="addLivestock()">+ Add Livestock Type</button>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('farm-info')">‚Üê Back</button>
                    <button class="btn" onclick="switchTab('feed')">Next: Feed Input ‚Üí</button>
                </div>
            </div>
            
            <!-- Feed Tab -->
            <div id="feed" class="tab-content">
                <h2 class="section-title">Feed and Fodder Input (NET: Imported - Exported)</h2>
                <div id="feedContainer"></div>
                <button class="btn btn-add" onclick="addFeed()">+ Add Feed Type</button>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('livestock')">‚Üê Back</button>
                    <button class="btn" onclick="switchTab('crops')">Next: Crop Production ‚Üí</button>
                </div>
            </div>
            
            <!-- Crops Tab -->
            <div id="crops" class="tab-content">
                <h2 class="section-title">Crop Production (Cash Crops Sold Off-Farm)</h2>
                <div id="cropContainer"></div>
                <button class="btn btn-add" onclick="addCrop()">+ Add Crop Type</button>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('feed')">‚Üê Back</button>
                    <button class="btn" onclick="switchTab('manure-production')">Next: Manure Production ‚Üí</button>
                </div>
            </div>
            
            <!-- Manure Production Tab -->
            <div id="manure-production" class="tab-content">
                <h2 class="section-title">Manure Production Summary</h2>
                
                <div class="alert alert-info">
                    This section automatically calculates manure production based on your livestock data.
                    The system uses excretion coefficients to estimate total N and P in manure.
                </div>
                
                <div id="manureProductionSummary" class="manure-summary">
                    <h4>üìä Calculated Manure Production</h4>
                    <p>Complete livestock data to see manure production estimates.</p>
                </div>
                
                <div class="flow-diagram">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">üîÑ Manure Flow Process</h4>
                    <div class="flow-step">
                        <span>üêÑ Animals</span>
                        <span class="flow-arrow">‚Üí</span>
                        <span>üí© Manure Production (Excretion)</span>
                        <span class="flow-arrow">‚Üí</span>
                        <span>‚öóÔ∏è Treatment (AD/Compost/Storage)</span>
                        <span class="flow-arrow">‚Üí</span>
                        <span>üåæ Destination (Land/Sale/Loss)</span>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('crops')">‚Üê Back</button>
                    <button class="btn" onclick="calculateManureProduction()">Calculate Manure Production</button>
                    <button class="btn" onclick="switchTab('manure-treatment')">Next: Manure Treatment ‚Üí</button>
                </div>
            </div>
            
            <!-- Manure Treatment Tab -->
            <div id="manure-treatment" class="tab-content">
                <h2 class="section-title">Manure Treatment Methods</h2>
                
                <div class="alert alert-warning">
                    <strong>Important:</strong> Specify what percentage of manure goes through each treatment method. 
                    Total must equal 100%. Each treatment has different N loss rates.
                </div>
                
                <div class="manure-treatment-box">
                    <h3 style="color: #e65100; margin-bottom: 15px;">Treatment Method 1: Anaerobic Digestion</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Percentage of Total Manure (%)</label>
                            <div class="percentage-input">
                                <input type="number" id="ad_percentage" placeholder="0-100" min="0" max="100" step="1" value="0">
                                <span>%</span>
                            </div>
                            <span class="help-text">Produces: Liquid digestate + Solid digestate</span>
                        </div>
                        <div class="form-group">
                            <label>N Loss Rate during AD (%)</label>
                            <input type="number" id="ad_n_loss" placeholder="Default: 20" step="0.1" value="20">
                            <span class="help-text">Typical: 15-25% (NH‚ÇÉ volatilization)</span>
                        </div>
                        <div class="form-group">
                            <label>P Loss Rate during AD (%)</label>
                            <input type="number" id="ad_p_loss" placeholder="Default: 0" step="0.1" value="0">
                            <span class="help-text">P is conserved (‚âà0% loss)</span>
                        </div>
                    </div>
                </div>
                
                <div class="manure-treatment-box">
                    <h3 style="color: #e65100; margin-bottom: 15px;">Treatment Method 2: Composting</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Percentage of Total Manure (%)</label>
                            <div class="percentage-input">
                                <input type="number" id="compost_percentage" placeholder="0-100" min="0" max="100" step="1" value="0">
                                <span>%</span>
                            </div>
                            <span class="help-text">Produces: Compost (solid organic fertilizer)</span>
                        </div>
                        <div class="form-group">
                            <label>N Loss Rate during Composting (%)</label>
                            <input type="number" id="compost_n_loss" placeholder="Default: 35" step="0.1" value="35">
                            <span class="help-text">Typical: 25-50% (NH‚ÇÉ + denitrification)</span>
                        </div>
                        <div class="form-group">
                            <label>P Loss Rate during Composting (%)</label>
                            <input type="number" id="compost_p_loss" placeholder="Default: 0" step="0.1" value="0">
                            <span class="help-text">P is conserved (‚âà0% loss)</span>
                        </div>
                    </div>
                </div>
                
                <div class="manure-treatment-box">
                    <h3 style="color: #e65100; margin-bottom: 15px;">Treatment Method 3: Direct Storage</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Percentage of Total Manure (%)</label>
                            <div class="percentage-input">
                                <input type="number" id="storage_percentage" placeholder="0-100" min="0" max="100" step="1" value="0">
                                <span>%</span>
                            </div>
                            <span class="help-text">Slurry pit or solid manure storage</span>
                        </div>
                        <div class="form-group">
                            <label>N Loss Rate during Storage (%)</label>
                            <input type="number" id="storage_n_loss" placeholder="Default: 20" step="0.1" value="20">
                            <span class="help-text">Typical: 10-30% (NH‚ÇÉ volatilization)</span>
                        </div>
                        <div class="form-group">
                            <label>P Loss Rate during Storage (%)</label>
                            <input type="number" id="storage_p_loss" placeholder="Default: 0" step="0.1" value="0">
                            <span class="help-text">P is conserved (‚âà0% loss)</span>
                        </div>
                    </div>
                </div>
                
                <div class="manure-treatment-box">
                    <h3 style="color: #e65100; margin-bottom: 15px;">Treatment Method 4: Direct Discharge (Áõ¥Êé•ÊéíÊîæ)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Percentage of Total Manure (%)</label>
                            <div class="percentage-input">
                                <input type="number" id="discharge_percentage" placeholder="0-100" min="0" max="100" step="1" value="0">
                                <span>%</span>
                            </div>
                            <span class="help-text" style="color: #e74c3c;">‚ö†Ô∏è Environmental discharge - not recommended</span>
                        </div>
                        <div class="form-group">
                            <label>N Loss Rate during Discharge (%)</label>
                            <input type="number" id="discharge_n_loss" placeholder="Default: 100" step="0.1" value="100">
                            <span class="help-text">All nutrients lost to environment</span>
                        </div>
                        <div class="form-group">
                            <label>P Loss Rate during Discharge (%)</label>
                            <input type="number" id="discharge_p_loss" placeholder="Default: 100" step="0.1" value="100">
                            <span class="help-text">All nutrients lost to environment</span>
                        </div>
                    </div>
                </div>
                
                <div class="balance-check">
                    <h4>‚úì Treatment Distribution Check</h4>
                    <p id="treatmentBalance">Total: <span id="totalTreatmentPercent">0</span>% (Must equal 100%)</p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('manure-production')">‚Üê Back</button>
                    <button class="btn" onclick="validateTreatment()">Validate Treatment %</button>
                    <button class="btn" onclick="switchTab('manure-destination')">Next: Manure Destination ‚Üí</button>
                </div>
            </div>
            
            <!-- Manure Destination Tab -->
            <div id="manure-destination" class="tab-content">
                <h2 class="section-title">Manure Destination & Utilization</h2>
                
                <div class="alert alert-info">
                    <strong>Specify where the treated manure goes:</strong> Land application (specify crop & area), 
                    sold/exported, or lost to environment. This determines I6 (net manure import/export).
                </div>
                
                <div id="manureDestinationSummary" class="manure-summary">
                    <h4>Available Manure After Treatment:</h4>
                    <p id="availableManureN">N: Calculate treatment first</p>
                    <p id="availableManureP">P: Calculate treatment first</p>
                </div>
                
                <h3 class="section-title">1. Land Application (Manure to Cropland)</h3>
                <div class="alert alert-info">
                    <strong>Select manure type and application details:</strong> Different manure products have different nutrient contents.
                </div>
                <div class="manure-destination-box">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Manure Type</label>
                            <select id="landManureType" onchange="updateLandManureNutrients()">
                                <option value="">-- Select Type --</option>
                                <option value="biogas_slurry">Biogas Slurry Ê≤ºÊ∂≤ (3.0 kg N/ton, 0.5 kg P/ton)</option>
                                <option value="biogas_residue">Biogas Residue Ê≤ºÊ∏£ (12.0 kg N/ton, 5.0 kg P/ton)</option>
                                <option value="compost">Compost Â†ÜËÇ• (8.0 kg N/ton, 4.0 kg P/ton)</option>
                                <option value="fresh_manure">Fresh Manure È≤úÁ≤™ (5.0 kg N/ton, 2.5 kg P/ton)</option>
                                <option value="slurry">Slurry Á≤™ÊµÜ (3.5 kg N/ton, 1.5 kg P/ton)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount Applied (tons/year)</label>
                            <input type="number" id="landManureAmount" placeholder="0" step="0.1" min="0" oninput="updateLandManureNutrients()">
                        </div>
                        <div class="form-group">
                            <label>Application Method</label>
                            <select id="landApplicationMethod">
                                <option value="broadcast">Surface Broadcasting Ë°®Èù¢ÊííÊñΩ</option>
                                <option value="injection">Injection Ê≥®ÂÖ•</option>
                                <option value="incorporation">Incorporation within 24h</option>
                                <option value="fertigation">Fertigation ÈöèÊ∞¥ÊñΩËÇ•</option>
                            </select>
                        </div>
                    </div>
                    <div id="landManureNutrientInfo" style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 5px; display: none;">
                        <strong>Estimated Nutrients Applied:</strong>
                        <span style="margin-left: 15px; color: #2e7d32; font-weight: 600;">N: <span id="landManureN">0</span> kg</span>
                        <span style="margin-left: 15px; color: #1565c0; font-weight: 600;">P: <span id="landManureP">0</span> kg</span>
                    </div>
                </div>
                
                <h3 class="section-title">2. Manure Export/Sale</h3>
                <div class="alert alert-info">
                    <strong>Multiple export records supported:</strong> Add separate records for different manure types and destinations.
                </div>
                <div id="exportEntries"></div>
                <button class="btn btn-add" onclick="addExportEntry()">+ Add Export Record</button>
                <div id="totalExportSummary" style="margin-top: 15px; display: none;"></div>
                
                <h3 class="section-title">3. Manure Import (if any)</h3>
                <div class="manure-destination-box">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Imported Manure Type</label>
                            <select id="importManureType">
                                <option value="">No import</option>
                                <option value="compost">Compost</option>
                                <option value="raw_slurry">Raw Slurry</option>
                                <option value="solid_manure">Solid Manure</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Import Amount (tons/year)</label>
                            <input type="number" id="importAmount" placeholder="Enter amount" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label>N Content (kg N/ton)</label>
                            <input type="number" id="importN" placeholder="Auto or manual" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>P Content (kg P/ton)</label>
                            <input type="number" id="importP" placeholder="Auto or manual" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="balance-check">
                    <h4>üîç Manure Mass Balance</h4>
                    <p id="manureBalanceCheck">Complete all sections to check balance</p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('manure-treatment')">‚Üê Back</button>
                    <button class="btn" onclick="calculateManureBalance()">Calculate Manure Balance</button>
                    <button class="btn" onclick="switchTab('other-inputs')">Next: Other Inputs ‚Üí</button>
                </div>
            </div>
            
            <!-- Other Inputs Tab -->
            <div id="other-inputs" class="tab-content">
                <h2 class="section-title">Other Inputs</h2>
                
                <div class="input-section">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Mineral Fertilizers</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>N Fertilizer (kg N/ha/yr)</label>
                            <input type="number" id="mineralN" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>P Fertilizer (kg P/ha/yr)</label>
                            <input type="number" id="mineralP" placeholder="0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="input-section">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Biological N‚ÇÇ Fixation & Deposition</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Biological N‚ÇÇ Fixation (kg N/ha/yr)</label>
                            <input type="number" id="bioFixation" placeholder="0" step="0.1">
                            <span class="help-text">From legumes (alfalfa, clover, soybean)</span>
                        </div>
                        <div class="form-group">
                            <label>Atmospheric N Deposition (kg N/ha/yr)</label>
                            <input type="number" id="atmDeposition" placeholder="15" step="0.1" value="15">
                            <span class="help-text">Typical: 10-30 kg N/ha/yr in China</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-section">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Other Minor Inputs</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bedding Material N (kg N/ha/yr)</label>
                            <input type="number" id="beddingN" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Bedding Material P (kg P/ha/yr)</label>
                            <input type="number" id="beddingP" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Irrigation Water N (kg N/ha/yr)</label>
                            <input type="number" id="irrigationN" placeholder="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Irrigation Water P (kg P/ha/yr)</label>
                            <input type="number" id="irrigationP" placeholder="0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchTab('manure-destination')">‚Üê Back</button>
                    <button class="btn" onclick="calculateFinalResults()">üßÆ Calculate Complete Nutrient Balance</button>
                </div>
            </div>
            
            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div id="resultsDisplay">
                    <div class="alert alert-info">
                        Please complete all sections including the complete manure management chain, 
                        then click "Calculate Complete Nutrient Balance".
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Manure type nutrient content database (kg/ton)
        const MANURE_TYPES = {
            biogas_slurry: {name: "Biogas Slurry (Ê≤ºÊ∂≤)", name_zh: "Ê≤ºÊ∂≤", n_content: 3.0, p_content: 0.5},
            biogas_residue: {name: "Biogas Residue (Ê≤ºÊ∏£)", name_zh: "Ê≤ºÊ∏£", n_content: 12.0, p_content: 5.0},
            compost: {name: "Compost (Â†ÜËÇ•)", name_zh: "Â†ÜËÇ•", n_content: 8.0, p_content: 4.0},
            fresh_manure: {name: "Fresh Manure (È≤úÁ≤™)", name_zh: "È≤úÁ≤™", n_content: 5.0, p_content: 2.5},
            slurry: {name: "Slurry (Á≤™ÊµÜ)", name_zh: "Á≤™ÊµÜ", n_content: 3.5, p_content: 1.5}
        };
        
        // Nutrient parameters database
        const NUTRIENT_DB = {
            livestock: {
                'dairy_cow_8000kg': {name: 'Dairy Cow (8000 kg milk/yr)', n_excretion: 126, p_excretion: 18.4},
                'dairy_cow_10000kg': {name: 'Dairy Cow (10000 kg milk/yr)', n_excretion: 142, p_excretion: 20.9},
                'dairy_calf': {name: 'Dairy Calf (0-1 yr)', n_excretion: 34, p_excretion: 4.2},
                'fattening_pig': {name: 'Fattening Pig', n_excretion: 13, p_excretion: 2.3},
                'sow': {name: 'Sow/Boar', n_excretion: 16, p_excretion: 4},
                'laying_hen': {name: 'Laying Hen', n_excretion: 0.8, p_excretion: 0.2},
                'broiler': {name: 'Broiler (<2kg)', n_excretion: 0.5, p_excretion: 0.2},
                'sheep': {name: 'Sheep (‚â•1 yr)', n_excretion: 10, p_excretion: 1.4}
            },
            feed: {
                'concentrate_20': {name: 'Concentrate (20% protein)', n: 32, p: 5},
                'forage_maize': {name: 'Forage Maize (silage)', n: 11, p: 2},
                'alfalfa_hay': {name: 'Alfalfa Hay', n: 48, p: 4},
                'corn_grain': {name: 'Corn Grain', n: 13, p: 2}
            },
            crops: {
                'wheat': {name: 'Wheat', n: 0.021, p: 0.0041},
                'rice': {name: 'Rice', n: 0.017, p: 0.0035},
                'maize': {name: 'Maize', n: 0.015, p: 0.0049},
                'vegetables': {name: 'Vegetables (avg)', n: 0.0148, p: 0.0026}
            },
            animalProducts: {
                'milk': {name: 'Milk', n: 5.6, p: 1.0},
                'eggs': {name: 'Eggs', n: 20, p: 2},
                'cattle_meat': {name: 'Cattle', n: 27, p: 5},
                'pig_meat': {name: 'Pig', n: 23, p: 5}
            },
            manureProducts: {
                'liquid_digestate': {name: 'Liquid Digestate', n: 4, p: 1},
                'solid_digestate': {name: 'Solid Digestate', n: 15, p: 10},
                'compost': {name: 'Compost', n: 20, p: 12},
                'raw_slurry': {name: 'Raw Slurry', n: 5, p: 1},
                'solid_manure': {name: 'Solid Manure', n: 20, p: 4}
            }
        };
        
        let livestockCount = 0;
        let feedCount = 0;
        let cropCount = 0;
        let landAppCount = 0;
        let exportCount = 0;
        let manureProduction = {n: 0, p: 0};
        let manureAfterTreatment = {n: 0, p: 0};
        
        document.addEventListener('DOMContentLoaded', function() {
            addLivestock();
            addFeed();
            addCrop();
            
            // Update treatment total when percentages change
            ['ad_percentage', 'compost_percentage', 'storage_percentage', 'discharge_percentage'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateTreatmentTotal);
            });
            
            // Auto-fill import manure N/P content
            document.getElementById('importManureType').addEventListener('change', function() {
                const type = this.value;
                if (type && NUTRIENT_DB.manureProducts[type]) {
                    document.getElementById('importN').value = NUTRIENT_DB.manureProducts[type].n;
                    document.getElementById('importP').value = NUTRIENT_DB.manureProducts[type].p;
                }
            });
        });
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            window.scrollTo(0, 0);
        }
        
        function getInputValue(id, defaultValue = 0) {
            const el = document.getElementById(id);
            if (!el) return defaultValue;
            const val = parseFloat(el.value);
            return isNaN(val) ? defaultValue : val;
        }
        
        function addLivestock() {
            livestockCount++;
            const container = document.getElementById('livestockContainer');
            const entry = document.createElement('div');
            entry.className = 'livestock-entry';
            entry.id = `livestock-${livestockCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <h4>Livestock #${livestockCount}</h4>
                    <button class="btn btn-remove" onclick="removeEntry('livestock-${livestockCount}')">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Animal Type</label>
                        <select id="livestock-type-${livestockCount}" onchange="updateLivestockParams(${livestockCount})">
                            <option value="">Select type</option>
                            ${Object.keys(NUTRIENT_DB.livestock).map(k => 
                                `<option value="${k}">${NUTRIENT_DB.livestock[k].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Number</label>
                        <input type="number" id="livestock-number-${livestockCount}" placeholder="Count" step="1">
                    </div>
                    <div class="form-group">
                        <label>N Excretion (kg/head/yr)</label>
                        <input type="number" id="livestock-n-${livestockCount}" placeholder="Auto" step="0.1" readonly>
                    </div>
                    <div class="form-group">
                        <label>P Excretion (kg/head/yr)</label>
                        <input type="number" id="livestock-p-${livestockCount}" placeholder="Auto" step="0.1" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Product Type</label>
                        <select id="livestock-product-${livestockCount}">
                            <option value="">None</option>
                            ${Object.keys(NUTRIENT_DB.animalProducts).map(k => 
                                `<option value="${k}">${NUTRIENT_DB.animalProducts[k].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Product Amount (kg or L/yr)</label>
                        <input type="number" id="livestock-product-amt-${livestockCount}" placeholder="Amount" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Animals Sold (net)</label>
                        <input type="number" id="livestock-sold-${livestockCount}" placeholder="Number" step="1">
                    </div>
                    <div class="form-group">
                        <label>Avg Weight (kg)</label>
                        <input type="number" id="livestock-weight-${livestockCount}" placeholder="Weight" step="1">
                    </div>
                </div>
            `;
            container.appendChild(entry);
        }
        
        function updateLivestockParams(id) {
            const type = document.getElementById(`livestock-type-${id}`).value;
            if (type && NUTRIENT_DB.livestock[type]) {
                document.getElementById(`livestock-n-${id}`).value = NUTRIENT_DB.livestock[type].n_excretion;
                document.getElementById(`livestock-p-${id}`).value = NUTRIENT_DB.livestock[type].p_excretion;
            }
        }
        
        function addFeed() {
            feedCount++;
            const container = document.getElementById('feedContainer');
            const entry = document.createElement('div');
            entry.className = 'feed-entry';
            entry.id = `feed-${feedCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <h4>Feed #${feedCount}</h4>
                    <button class="btn btn-remove" onclick="removeEntry('feed-${feedCount}')">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Feed Type</label>
                        <select id="feed-type-${feedCount}" onchange="updateFeedParams(${feedCount})">
                            <option value="">Select feed</option>
                            ${Object.keys(NUTRIENT_DB.feed).map(k => 
                                `<option value="${k}">${NUTRIENT_DB.feed[k].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (tons DM/yr)</label>
                        <input type="number" id="feed-amount-${feedCount}" placeholder="Amount" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>N Content (g/kg DM)</label>
                        <input type="number" id="feed-n-${feedCount}" placeholder="Auto" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>P Content (g/kg DM)</label>
                        <input type="number" id="feed-p-${feedCount}" placeholder="Auto" step="0.1">
                    </div>
                </div>
            `;
            container.appendChild(entry);
        }
        
        function updateFeedParams(id) {
            const type = document.getElementById(`feed-type-${id}`).value;
            if (type && NUTRIENT_DB.feed[type]) {
                document.getElementById(`feed-n-${id}`).value = NUTRIENT_DB.feed[type].n;
                document.getElementById(`feed-p-${id}`).value = NUTRIENT_DB.feed[type].p;
            }
        }
        
        function addCrop() {
            cropCount++;
            const container = document.getElementById('cropContainer');
            const entry = document.createElement('div');
            entry.className = 'crop-entry';
            entry.id = `crop-${cropCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <h4>Crop #${cropCount}</h4>
                    <button class="btn btn-remove" onclick="removeEntry('crop-${cropCount}')">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Crop Type</label>
                        <select id="crop-type-${cropCount}" onchange="updateCropParams(${cropCount})">
                            <option value="">Select crop</option>
                            ${Object.keys(NUTRIENT_DB.crops).map(k => 
                                `<option value="${k}">${NUTRIENT_DB.crops[k].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Yield (tons/yr)</label>
                        <input type="number" id="crop-yield-${cropCount}" placeholder="Yield" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>N Content (kg/kg)</label>
                        <input type="number" id="crop-n-${cropCount}" placeholder="Auto" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label>P Content (kg/kg)</label>
                        <input type="number" id="crop-p-${cropCount}" placeholder="Auto" step="0.0001">
                    </div>
                </div>
            `;
            container.appendChild(entry);
        }
        
        function updateCropParams(id) {
            const type = document.getElementById(`crop-type-${id}`).value;
            if (type && NUTRIENT_DB.crops[type]) {
                document.getElementById(`crop-n-${id}`).value = NUTRIENT_DB.crops[type].n;
                document.getElementById(`crop-p-${id}`).value = NUTRIENT_DB.crops[type].p;
            }
        }
        
        function addLandApplication() {
            landAppCount++;
            const container = document.getElementById('landApplicationContainer');
            const entry = document.createElement('div');
            entry.className = 'manure-destination-box';
            entry.id = `landapp-${landAppCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <h4>Land Application #${landAppCount}</h4>
                    <button class="btn btn-remove" onclick="removeEntry('landapp-${landAppCount}')">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Crop Type</label>
                        <select id="landapp-crop-${landAppCount}">
                            ${Object.keys(NUTRIENT_DB.crops).map(k => 
                                `<option value="${k}">${NUTRIENT_DB.crops[k].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Application Area (ha)</label>
                        <input type="number" id="landapp-area-${landAppCount}" placeholder="Area" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Manure Application Rate (tons/ha)</label>
                        <input type="number" id="landapp-rate-${landAppCount}" placeholder="Rate" step="0.1">
                        <span class="help-text">Fresh weight basis</span>
                    </div>
                    <div class="form-group">
                        <label>Manure N Content (kg N/ton)</label>
                        <input type="number" id="landapp-n-${landAppCount}" placeholder="e.g., 5" step="0.1" value="5">
                    </div>
                </div>
            `;
            container.appendChild(entry);
        }
        
        function removeEntry(id) {
            document.getElementById(id)?.remove();
        }
        
        // New functions for manure type selection and export management
        function updateLandManureNutrients() {
            const type = document.getElementById('landManureType')?.value;
            const amount = getInputValue('landManureAmount');
            
            if (type && MANURE_TYPES[type] && amount > 0) {
                const nContent = amount * MANURE_TYPES[type].n_content;
                const pContent = amount * MANURE_TYPES[type].p_content;
                
                document.getElementById('landManureN').textContent = nContent.toFixed(1);
                document.getElementById('landManureP').textContent = pContent.toFixed(1);
                document.getElementById('landManureNutrientInfo').style.display = 'block';
            } else {
                document.getElementById('landManureNutrientInfo').style.display = 'none';
            }
        }
        
        function addExportEntry() {
            exportCount++;
            const html = `
                <div class="export-entry" id="export-${exportCount}">
                    <button class="remove-btn" onclick="removeExportEntry(${exportCount})" title="Remove this record">√ó</button>
                    <h4 style="margin-bottom: 15px; color: #2e7d32;">Export Record ${exportCount}</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Manure Type</label>
                            <select id="export-type-${exportCount}" onchange="updateExportNutrients(${exportCount})">
                                <option value="">-- Select Type --</option>
                                ${Object.keys(MANURE_TYPES).map(k => 
                                    `<option value="${k}">${MANURE_TYPES[k].name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount Exported (tons/year)</label>
                            <input type="number" id="export-amount-${exportCount}" placeholder="0" step="0.1" min="0" oninput="updateExportNutrients(${exportCount})">
                        </div>
                        <div class="form-group">
                            <label>Destination</label>
                            <input type="text" id="export-dest-${exportCount}" placeholder="e.g., Nearby farms">
                        </div>
                    </div>
                    <div id="export-nutrient-${exportCount}" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 5px; display: none;">
                        <strong>Nutrients Exported:</strong>
                        <span style="margin-left: 15px; color: #e65100; font-weight: 600;">N: <span id="export-n-${exportCount}">0</span> kg</span>
                        <span style="margin-left: 15px; color: #e65100; font-weight: 600;">P: <span id="export-p-${exportCount}">0</span> kg</span>
                    </div>
                </div>
            `;
            document.getElementById('exportEntries').insertAdjacentHTML('beforeend', html);
        }
        
        function removeExportEntry(id) {
            const entry = document.getElementById(`export-${id}`);
            if (entry && confirm('Remove this export record?')) {
                entry.remove();
                updateTotalExports();
            }
        }
        
        function updateExportNutrients(id) {
            const type = document.getElementById(`export-type-${id}`)?.value;
            const amount = getInputValue(`export-amount-${id}`);
            
            if (type && MANURE_TYPES[type] && amount > 0) {
                const nExport = amount * MANURE_TYPES[type].n_content;
                const pExport = amount * MANURE_TYPES[type].p_content;
                
                document.getElementById(`export-n-${id}`).textContent = nExport.toFixed(1);
                document.getElementById(`export-p-${id}`).textContent = pExport.toFixed(1);
                document.getElementById(`export-nutrient-${id}`).style.display = 'block';
            } else {
                document.getElementById(`export-nutrient-${id}`).style.display = 'none';
            }
            
            updateTotalExports();
        }
        
        function updateTotalExports() {
            let totalN = 0;
            let totalP = 0;
            let count = 0;
            
            for (let i = 1; i <= exportCount; i++) {
                const entry = document.getElementById(`export-${i}`);
                if (!entry) continue;
                
                const type = document.getElementById(`export-type-${i}`)?.value;
                const amount = getInputValue(`export-amount-${i}`);
                
                if (type && MANURE_TYPES[type] && amount > 0) {
                    totalN += amount * MANURE_TYPES[type].n_content;
                    totalP += amount * MANURE_TYPES[type].p_content;
                    count++;
                }
            }
            
            const summaryDiv = document.getElementById('totalExportSummary');
            if (count > 0) {
                summaryDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üìä Total Exports Summary</h4>
                        <p><strong>${count}</strong> export record(s)</p>
                        <p><strong>Total N exported:</strong> ${totalN.toFixed(1)} kg/year</p>
                        <p><strong>Total P exported:</strong> ${totalP.toFixed(1)} kg/year</p>
                    </div>
                `;
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }
        
        function calculateManureProduction() {
            let totalN = 0, totalP = 0;
            let details = [];
            
            for (let i = 1; i <= livestockCount; i++) {
                const number = getInputValue(`livestock-number-${i}`);
                const nExcr = getInputValue(`livestock-n-${i}`);
                const pExcr = getInputValue(`livestock-p-${i}`);
                
                if (number > 0) {
                    const n = number * nExcr;
                    const p = number * pExcr;
                    totalN += n;
                    totalP += p;
                    
                    const type = document.getElementById(`livestock-type-${i}`)?.value;
                    const typeName = type && NUTRIENT_DB.livestock[type] ? NUTRIENT_DB.livestock[type].name : 'Animals';
                    details.push(`${number} ${typeName}: ${n.toFixed(1)} kg N, ${p.toFixed(1)} kg P`);
                }
            }
            
            manureProduction = {n: totalN, p: totalP};
            
            const summary = `
                <h4>üìä Total Manure Production (Excretion)</h4>
                <p style="font-size: 18px; font-weight: bold; color: #1976d2;">
                    Total N: ${totalN.toFixed(1)} kg/year | Total P: ${totalP.toFixed(1)} kg/year
                </p>
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                    ${details.map(d => `<p style="margin: 5px 0;">‚Ä¢ ${d}</p>`).join('')}
                </div>
                <p style="margin-top: 15px; font-style: italic; color: #666;">
                    This manure will go through treatment (AD/Compost/Storage) before utilization.
                </p>
            `;
            
            document.getElementById('manureProductionSummary').innerHTML = summary;
            alert('Manure production calculated! Total N: ' + totalN.toFixed(1) + ' kg/yr, Total P: ' + totalP.toFixed(1) + ' kg/yr');
        }
        
        function updateTreatmentTotal() {
            const ad = getInputValue('ad_percentage');
            const compost = getInputValue('compost_percentage');
            const storage = getInputValue('storage_percentage');
            const discharge = getInputValue('discharge_percentage');
            const total = ad + compost + storage + discharge;
            
            document.getElementById('totalTreatmentPercent').textContent = total.toFixed(0);
            
            const balanceEl = document.getElementById('treatmentBalance');
            if (total === 100) {
                balanceEl.style.color = '#155724';
                balanceEl.style.fontWeight = 'bold';
            } else {
                balanceEl.style.color = '#856404';
            }
        }
        
        function validateTreatment() {
            const total = getInputValue('ad_percentage') + getInputValue('compost_percentage') + getInputValue('storage_percentage') + getInputValue('discharge_percentage');
            if (total !== 100) {
                alert('Treatment percentages must sum to 100%! Current total: ' + total + '%');
                return false;
            }
            alert('‚úì Treatment distribution is valid (100%)');
            return true;
        }
        
        function calculateManureBalance() {
            if (manureProduction.n === 0) {
                alert('Please calculate manure production first!');
                return;
            }
            
            // Calculate losses during treatment
            const adPct = getInputValue('ad_percentage') / 100;
            const compostPct = getInputValue('compost_percentage') / 100;
            const storagePct = getInputValue('storage_percentage') / 100;
            const dischargePct = getInputValue('discharge_percentage') / 100;
            
            const adNLoss = getInputValue('ad_n_loss') / 100;
            const compostNLoss = getInputValue('compost_n_loss') / 100;
            const storageNLoss = getInputValue('storage_n_loss') / 100;
            const dischargeNLoss = getInputValue('discharge_n_loss') / 100;
            
            const adPLoss = getInputValue('ad_p_loss') / 100;
            const compostPLoss = getInputValue('compost_p_loss') / 100;
            const storagePLoss = getInputValue('storage_p_loss') / 100;
            const dischargePLoss = getInputValue('discharge_p_loss') / 100;
            
            // Calculate remaining N and P after treatment
            const nAfterAD = manureProduction.n * adPct * (1 - adNLoss);
            const nAfterCompost = manureProduction.n * compostPct * (1 - compostNLoss);
            const nAfterStorage = manureProduction.n * storagePct * (1 - storageNLoss);
            const nAfterDischarge = manureProduction.n * dischargePct * (1 - dischargeNLoss);
            
            const pAfterAD = manureProduction.p * adPct * (1 - adPLoss);
            const pAfterCompost = manureProduction.p * compostPct * (1 - compostPLoss);
            const pAfterStorage = manureProduction.p * storagePct * (1 - storagePLoss);
            const pAfterDischarge = manureProduction.p * dischargePct * (1 - dischargePLoss);
            
            const totalNAfter = nAfterAD + nAfterCompost + nAfterStorage + nAfterDischarge;
            const totalPAfter = pAfterAD + pAfterCompost + pAfterStorage + pAfterDischarge;
            
            const totalNLoss = manureProduction.n - totalNAfter;
            const totalPLoss = manureProduction.p - totalPAfter;
            
            manureAfterTreatment = {n: totalNAfter, p: totalPAfter};
            
            document.getElementById('availableManureN').textContent = `Available N: ${totalNAfter.toFixed(1)} kg/yr (Lost during treatment: ${totalNLoss.toFixed(1)} kg)`;
            document.getElementById('availableManureP').textContent = `Available P: ${totalPAfter.toFixed(1)} kg/yr (Lost during treatment: ${totalPLoss.toFixed(1)} kg)`;
            
            // Calculate land application
            const landType = document.getElementById('landManureType')?.value;
            const landAmount = getInputValue('landManureAmount');
            let landAppN = 0, landAppP = 0;
            if (landType && MANURE_TYPES[landType] && landAmount > 0) {
                landAppN = landAmount * MANURE_TYPES[landType].n_content;
                landAppP = landAmount * MANURE_TYPES[landType].p_content;
            }
            
            // Calculate total exports from multiple records
            let totalExportN = 0, totalExportP = 0;
            for (let i = 1; i <= exportCount; i++) {
                const entry = document.getElementById(`export-${i}`);
                if (!entry) continue;
                
                const type = document.getElementById(`export-type-${i}`)?.value;
                const amount = getInputValue(`export-amount-${i}`);
                if (type && MANURE_TYPES[type] && amount > 0) {
                    totalExportN += amount * MANURE_TYPES[type].n_content;
                    totalExportP += amount * MANURE_TYPES[type].p_content;
                }
            }
            
            const importAmt = getInputValue('importAmount');
            const importN = getInputValue('importN');
            const importP = getInputValue('importP');
            const totalImportN = importAmt * importN;
            const totalImportP = importAmt * importP;
            
            const balanceN = totalNAfter - landAppN - totalExportN;
            const balanceP = totalPAfter - landAppP - totalExportP;
            
            const balanceHtml = `
                <strong>Manure N Balance:</strong><br>
                Produced: ${manureProduction.n.toFixed(1)} kg<br>
                Lost in treatment: ${totalNLoss.toFixed(1)} kg<br>
                Available after treatment: ${totalNAfter.toFixed(1)} kg<br>
                Land application: ${landAppN.toFixed(1)} kg<br>
                Export: ${totalExportN.toFixed(1)} kg<br>
                <strong>Remaining/Unaccounted: ${balanceN.toFixed(1)} kg</strong><br>
                ${balanceN > 10 ? '<span style="color: #e74c3c;">‚ö†Ô∏è Significant unaccounted N - specify more destinations</span>' : '<span style="color: #27ae60;">‚úì Balance looks good</span>'}
            `;
            
            document.getElementById('manureBalanceCheck').innerHTML = balanceHtml;
        }
        
        function calculateFinalResults() {
            const farmArea = getInputValue('farmArea');
            if (farmArea <= 0) {
                alert('Please enter valid farm area!');
                return;
            }
            
            if (manureProduction.n === 0) {
                if (!confirm('Manure production not calculated. Continue anyway?')) return;
            }
            
            // Calculate all inputs and outputs
            const results = {
                inputs: {i1: 0, i2: 0, i3: 0, i4: 0, i5: 0, i6: 0, i7: 0, i8: 0, i9: 0},
                inputs_p: {i1: 0, i2: 0, i3: 0, i4: 0, i5: 0, i6: 0, i7: 0, i8: 0, i9: 0},
                outputs: {o1: 0, o2: 0, o3: 0},
                outputs_p: {o1: 0, o2: 0, o3: 0}
            };
            
            // I1: Mineral fertilizers
            results.inputs.i1 = getInputValue('mineralN');
            results.inputs_p.i1 = getInputValue('mineralP');
            
            // I2: Feed
            let totalFeedN = 0, totalFeedP = 0;
            for (let i = 1; i <= feedCount; i++) {
                const amt = getInputValue(`feed-amount-${i}`);
                const n = getInputValue(`feed-n-${i}`);
                const p = getInputValue(`feed-p-${i}`);
                totalFeedN += amt * 1000 * n / 1000;
                totalFeedP += amt * 1000 * p / 1000;
            }
            results.inputs.i2 = totalFeedN / farmArea;
            results.inputs_p.i2 = totalFeedP / farmArea;
            
            // I3, I4: Bio fixation and deposition
            results.inputs.i3 = getInputValue('bioFixation');
            results.inputs.i4 = getInputValue('atmDeposition', 15);
            
            // I5: Bedding
            results.inputs.i5 = getInputValue('beddingN');
            results.inputs_p.i5 = getInputValue('beddingP');
            
            // I6: NET manure import (import - export)
            const importAmt = getInputValue('importAmount');
            const importN = getInputValue('importN');
            const importP = getInputValue('importP');
            
            // Calculate total exports from multiple records
            let totalExportN = 0, totalExportP = 0;
            for (let i = 1; i <= exportCount; i++) {
                const entry = document.getElementById(`export-${i}`);
                if (!entry) continue;
                
                const type = document.getElementById(`export-type-${i}`)?.value;
                const amount = getInputValue(`export-amount-${i}`);
                if (type && MANURE_TYPES[type] && amount > 0) {
                    totalExportN += amount * MANURE_TYPES[type].n_content;
                    totalExportP += amount * MANURE_TYPES[type].p_content;
                }
            }
            
            const netManureN = (importAmt * importN - totalExportN);
            const netManureP = (importAmt * importP - totalExportP);
            results.inputs.i6 = netManureN / farmArea;
            results.inputs_p.i6 = netManureP / farmArea;
            
            // I8: Irrigation
            results.inputs.i8 = getInputValue('irrigationN');
            results.inputs_p.i8 = getInputValue('irrigationP');
            
            // O1: Animal products
            let totalProdN = 0, totalProdP = 0;
            for (let i = 1; i <= livestockCount; i++) {
                const prodType = document.getElementById(`livestock-product-${i}`)?.value;
                const prodAmt = getInputValue(`livestock-product-amt-${i}`);
                if (prodType && prodAmt > 0 && NUTRIENT_DB.animalProducts[prodType]) {
                    totalProdN += prodAmt * NUTRIENT_DB.animalProducts[prodType].n / 1000;
                    totalProdP += prodAmt * NUTRIENT_DB.animalProducts[prodType].p / 1000;
                }
            }
            results.outputs.o1 = totalProdN / farmArea;
            results.outputs_p.o1 = totalProdP / farmArea;
            
            // O2: Animals sold
            let totalAnimalN = 0, totalAnimalP = 0;
            for (let i = 1; i <= livestockCount; i++) {
                const sold = getInputValue(`livestock-sold-${i}`);
                const weight = getInputValue(`livestock-weight-${i}`);
                if (sold > 0 && weight > 0) {
                    totalAnimalN += sold * weight * 27 / 1000; // Use avg 27 g N/kg
                    totalAnimalP += sold * weight * 5 / 1000;
                }
            }
            results.outputs.o2 = totalAnimalN / farmArea;
            results.outputs_p.o2 = totalAnimalP / farmArea;
            
            // O3: Crops
            let totalCropN = 0, totalCropP = 0;
            for (let i = 1; i <= cropCount; i++) {
                const yield_amt = getInputValue(`crop-yield-${i}`);
                const n = getInputValue(`crop-n-${i}`);
                const p = getInputValue(`crop-p-${i}`);
                totalCropN += yield_amt * 1000 * n;
                totalCropP += yield_amt * 1000 * p;
            }
            results.outputs.o3 = totalCropN / farmArea;
            results.outputs_p.o3 = totalCropP / farmArea;
            
            // Calculate totals and indicators
            const totalInN = Object.values(results.inputs).reduce((a,b) => a+b, 0);
            const totalInP = Object.values(results.inputs_p).reduce((a,b) => a+b, 0);
            const totalOutN = Object.values(results.outputs).reduce((a,b) => a+b, 0);
            const totalOutP = Object.values(results.outputs_p).reduce((a,b) => a+b, 0);
            
            const nue = totalInN > 0 ? (totalOutN / totalInN * 100) : 0;
            const pue = totalInP > 0 ? (totalOutP / totalInP * 100) : 0;
            const nSurplus = totalInN - totalOutN;
            const pSurplus = totalInP - totalOutP;
            
            displayResults(results, totalInN, totalInP, totalOutN, totalOutP, nue, pue, nSurplus, pSurplus);
            switchTab('results');
        }
        
        function displayResults(calc, totalInN, totalInP, totalOutN, totalOutP, nue, pue, nSurplus, pSurplus) {
            const farmName = document.getElementById('farmName').value || 'Farm';
            const farmArea = getInputValue('farmArea');
            
            const html = `
                <div class="alert alert-success">
                    ‚úì Complete nutrient balance calculated including full manure management chain!
                </div>
                
                <div class="indicator-cards">
                    <div class="indicator-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                        <h3>N Use Efficiency</h3>
                        <div class="value">${nue.toFixed(1)}</div>
                        <div class="unit">%</div>
                    </div>
                    <div class="indicator-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <h3>P Use Efficiency</h3>
                        <div class="value">${pue.toFixed(1)}</div>
                        <div class="unit">%</div>
                    </div>
                    <div class="indicator-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        <h3>N-Surplus</h3>
                        <div class="value">${nSurplus.toFixed(1)}</div>
                        <div class="unit">kg/ha/yr</div>
                    </div>
                    <div class="indicator-card" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
                        <h3>P-Surplus</h3>
                        <div class="value">${pSurplus.toFixed(1)}</div>
                        <div class="unit">kg/ha/yr</div>
                    </div>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">Nutrient Balance Table</h2>
                <table class="results-table">
                    <thead>
                        <tr><th>ID</th><th>Flow</th><th>N (kg/ha/yr)</th><th>P (kg/ha/yr)</th></tr>
                    </thead>
                    <tbody>
                        <tr class="category-header"><td colspan="4">INPUTS</td></tr>
                        <tr><td>I1</td><td>Mineral fertilizers</td><td>${calc.inputs.i1.toFixed(2)}</td><td>${calc.inputs_p.i1.toFixed(2)}</td></tr>
                        <tr><td>I2</td><td>Feed (net)</td><td>${calc.inputs.i2.toFixed(2)}</td><td>${calc.inputs_p.i2.toFixed(2)}</td></tr>
                        <tr><td>I3</td><td>Biological N‚ÇÇ fixation</td><td>${calc.inputs.i3.toFixed(2)}</td><td>-</td></tr>
                        <tr><td>I4</td><td>Atmospheric deposition</td><td>${calc.inputs.i4.toFixed(2)}</td><td>-</td></tr>
                        <tr><td>I5</td><td>Bedding</td><td>${calc.inputs.i5.toFixed(2)}</td><td>${calc.inputs_p.i5.toFixed(2)}</td></tr>
                        <tr><td>I6</td><td>Manure (net)</td><td>${calc.inputs.i6.toFixed(2)}</td><td>${calc.inputs_p.i6.toFixed(2)}</td></tr>
                        <tr><td>I8</td><td>Irrigation</td><td>${calc.inputs.i8.toFixed(2)}</td><td>${calc.inputs_p.i8.toFixed(2)}</td></tr>
                        <tr class="total-row"><td>I·¥õ</td><td>Total Inputs</td><td>${totalInN.toFixed(2)}</td><td>${totalInP.toFixed(2)}</td></tr>
                        <tr class="category-header"><td colspan="4">OUTPUTS</td></tr>
                        <tr><td>O1</td><td>Animal products</td><td>${calc.outputs.o1.toFixed(2)}</td><td>${calc.outputs_p.o1.toFixed(2)}</td></tr>
                        <tr><td>O2</td><td>Animals (net)</td><td>${calc.outputs.o2.toFixed(2)}</td><td>${calc.outputs_p.o2.toFixed(2)}</td></tr>
                        <tr><td>O3</td><td>Cash crops</td><td>${calc.outputs.o3.toFixed(2)}</td><td>${calc.outputs_p.o3.toFixed(2)}</td></tr>
                        <tr class="total-row"><td>O·¥õ</td><td>Total Outputs</td><td>${totalOutN.toFixed(2)}</td><td>${totalOutP.toFixed(2)}</td></tr>
                    </tbody>
                </table>
                
                <div class="manure-summary" style="margin-top: 30px;">
                    <h4>üîÑ Manure Management Summary</h4>
                    <p><strong>Manure produced:</strong> ${manureProduction.n.toFixed(1)} kg N, ${manureProduction.p.toFixed(1)} kg P</p>
                    <p><strong>After treatment:</strong> ${manureAfterTreatment.n.toFixed(1)} kg N, ${manureAfterTreatment.p.toFixed(1)} kg P</p>
                    <p><strong>Treatment loss:</strong> ${(manureProduction.n - manureAfterTreatment.n).toFixed(1)} kg N</p>
                </div>
                
                <div class="button-group">
                    <button class="btn" onclick="window.print()">Print</button>
                    <button class="btn btn-secondary" onclick="location.reload()">New Calculation</button>
                </div>
            `;
            
            document.getElementById('resultsDisplay').innerHTML = html;
        }
    </script>
</body>
</html>
